# Story 1.1: Firebase Project Setup & Flutter Configuration

Status: done

## Story

As a **developer**,
I want **Firebase project configured with Flutter app**,
So that **I can access Firebase services (Auth, Firestore, Storage, Messaging)**.

## Acceptance Criteria

1. **Given** a Firebase project exists in Firebase Console
   **When** the Flutter app configuration files are added
   **Then** `google-services.json` is in `android/app/`
   **And** `GoogleService-Info.plist` is in `ios/Runner/`
   **And** `firebase_core` initializes successfully in `main.dart`

2. **Given** Firebase Emulators are installed
   **When** I run `firebase emulators:start`
   **Then** Auth, Firestore, and Storage emulators start successfully
   **And** Flutter app can connect to emulators for local development

3. **Given** the Flutter app launches
   **When** Firebase initializes
   **Then** no errors occur in console
   **And** app proceeds to home screen

## Tasks / Subtasks

- [x] **Task 1: Verify Firebase Console Setup** (AC: #1)
  - [x] 1.1 Confirm Firebase project `tourvn-app` exists in Console
  - [x] 1.2 Verify Android app is registered (package: `com.example.tourvn_app`)
  - [x] 1.3 Verify iOS app is registered (bundle ID: `com.example.tourvnApp`)
  - [x] 1.4 Download fresh `google-services.json` and place in `android/app/`
  - [x] 1.5 Download fresh `GoogleService-Info.plist` and place in `ios/Runner/`

- [x] **Task 2: Update Firebase Initialization** (AC: #1, #3)
  - [x] 2.1 Verify `firebase_options.dart` exists and is current
  - [x] 2.2 Update `main.dart` to initialize Firebase before `runApp()`
  - [x] 2.3 Wrap app in `ProviderScope` for Riverpod
  - [x] 2.4 Add error handling for Firebase initialization failures

- [x] **Task 3: Create Core Firebase Providers** (AC: #1)
  - [x] 3.1 Create `lib/core/providers/firebase_providers.dart`
  - [x] 3.2 Add `firestoreProvider` returning `FirebaseFirestore.instance`
  - [x] 3.3 Add `firebaseAuthProvider` returning `FirebaseAuth.instance`
  - [x] 3.4 Add `firebaseStorageProvider` returning `FirebaseStorage.instance`
  - [x] 3.5 Add `firebaseMessagingProvider` returning `FirebaseMessaging.instance`

- [x] **Task 4: Configure Firebase Emulators** (AC: #2)
  - [x] 4.1 Create `firebase.json` with emulator configuration
  - [x] 4.2 Add emulator connection logic in debug mode only
  - [x] 4.3 Test emulator connection with `flutter run`
  - [x] 4.4 Document emulator setup in project README

- [x] **Task 5: Verify All Services Connect** (AC: #3)
  - [x] 5.1 Test Firestore read/write in emulator
  - [x] 5.2 Test Auth sign-in flow in emulator
  - [x] 5.3 Verify no console errors on app launch

## Dev Notes

### Architecture Compliance

**Layer:** `core/providers/` - This story creates foundational providers used across all features.

**Pattern:** Providers use `@riverpod` annotation (code generation approach). Core providers are singletons returning Firebase instances.

**Import Path:** All features will import from `package:tourvn_app/core/providers/firebase_providers.dart`

### Technical Requirements

**Firebase SDK Versions (from pubspec.yaml - ALREADY INSTALLED):**
```yaml
firebase_core: ^3.8.1
firebase_auth: ^5.3.4
cloud_firestore: ^5.6.0
firebase_storage: ^12.4.0
firebase_messaging: ^15.1.6
```

**State Management:**
```yaml
flutter_riverpod: ^2.6.1
```

**CRITICAL:** Do NOT change these versions. They are already configured and compatible.

### File Structure Requirements

Create these files in exact locations:

```
lib/
├── core/
│   └── providers/
│       └── firebase_providers.dart    # NEW - Firebase instance providers
├── firebase_options.dart              # EXISTS - Generated by FlutterFire CLI
└── main.dart                          # UPDATE - Add Firebase init + ProviderScope
```

### Code Patterns

**Firebase Initialization (main.dart):**
```dart
import 'package:firebase_core/firebase_core.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'firebase_options.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  
  runApp(const ProviderScope(child: MyApp()));
}
```

**Firebase Providers Pattern (firebase_providers.dart):**
```dart
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

final firestoreProvider = Provider<FirebaseFirestore>((ref) {
  return FirebaseFirestore.instance;
});

final firebaseAuthProvider = Provider<FirebaseAuth>((ref) {
  return FirebaseAuth.instance;
});

final firebaseStorageProvider = Provider<FirebaseStorage>((ref) {
  return FirebaseStorage.instance;
});

final firebaseMessagingProvider = Provider<FirebaseMessaging>((ref) {
  return FirebaseMessaging.instance;
});
```

**Emulator Connection (debug mode only):**
```dart
import 'package:flutter/foundation.dart';

Future<void> _connectToEmulators() async {
  if (kDebugMode) {
    // Use 10.0.2.2 for Android emulator, localhost for iOS simulator
    const host = 'localhost'; // or '10.0.2.2' for Android
    
    FirebaseFirestore.instance.useFirestoreEmulator(host, 8080);
    await FirebaseAuth.instance.useAuthEmulator(host, 9099);
    await FirebaseStorage.instance.useStorageEmulator(host, 9199);
  }
}
```

### Project Structure Notes

**Existing Files to Preserve:**
- `firebase_options.dart` - Auto-generated, do not modify manually
- `google-services.json` - Already present in `android/app/`
- `pubspec.yaml` - Dependencies already configured

**Alignment with project-context.md:**
- Providers in `core/providers/` folder ✓
- Using `Provider<T>` for singletons (not `@riverpod` for simple instances) ✓
- Firebase instances accessed via providers, not directly ✓

### References

- [Source: _bmad-output/architecture.md#Core-Providers] - Firebase provider pattern
- [Source: _bmad-output/architecture.md#Firebase-Service-Boundaries] - Access via providers only
- [Source: project-context.md#State-Management-Rules] - Provider organization
- [Source: _bmad-output/epics.md#Story-1.1] - Original acceptance criteria

### Testing Requirements

**Manual Verification:**
1. Run `flutter run` - app should launch without Firebase errors
2. Check console for "Firebase initialized successfully" log
3. Run `firebase emulators:start` and verify connection in debug mode

**No unit tests required for this story** - Firebase providers are thin wrappers around Firebase SDK singletons.

### Dependencies

**Depends on:** Nothing - this is the foundation story

**Blocks:** All subsequent stories requiring Firebase services:
- Story 1.2 (Clean Architecture) - needs providers location
- Story 1.5 (Security Rules) - needs Firebase project
- Story 2.1 (Registration) - needs Auth provider
- Story 3.1 (Location Data Model) - needs Firestore provider

### Edge Cases & Error Handling

1. **Firebase Init Failure:** 
   - Catch `FirebaseException` in main()
   - Show error screen with retry option
   - Log error for debugging

2. **Missing Config Files:**
   - App will crash with clear error message
   - Developer must download files from Firebase Console

3. **Emulator Not Running:**
   - In debug mode, log warning but don't crash
   - Fallback to production Firebase (not recommended for dev)

### Performance Considerations

- Firebase initialization adds ~500ms to cold start (acceptable per NFR1: < 3s)
- Providers are lazy - Firebase instances created on first access
- No performance optimizations needed for this story

---

## Dev Agent Record

### Agent Model Used

Claude (Cascade Dev Agent - Amelia)

### Completion Notes List

- Verified Firebase project `tourvn-app` configured with Android/iOS apps
- Added error handling to `main.dart` with `FirebaseErrorApp` retry UI
- Created `firebase_providers.dart` with 4 providers (Firestore, Auth, Storage, Messaging)
- Created `FirebaseEmulatorService` for debug-mode emulator connection
- Updated `firebase.json` with emulator ports configuration
- Updated `README.md` with comprehensive emulator setup documentation
- All code passes `flutter analyze` with no issues

### Change Log

| Date | Change | Reason |
|------|--------|--------|
| 2025-12-23 | Story created | Initial story preparation |
| 2025-12-23 | Implementation complete | All 5 tasks implemented, ready for review |
| 2025-12-23 | Code review fixes | Fixed H1 (import order), M1 (web compatibility) |

### File List

_Files created/modified during implementation:_

- [x] `lib/core/providers/firebase_providers.dart` (CREATE)
- [x] `lib/core/services/firebase_emulator_service.dart` (CREATE)
- [x] `lib/main.dart` (UPDATE)
- [x] `firebase.json` (UPDATE)
- [x] `README.md` (UPDATE)
